// using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using DG.Tweening;
using Unity.VisualScripting;
using UnityEngine;
using UnityEngine.UI;


public class BlockCreator : MonoBehaviour
{
    // [SerializeField] private Material[] blockMaterials; // Các material khác nhau cho từng loại khối
    public SaveDataJson saveDataJson;
    public GameObject blockPrefab; // Khối 3D đơn sẽ được sử dụng để tạo các khối Tetris
    public GameObject MapFrame;
    public GameObject BlockFrame;
    public GameObject ListBlock;
    public Canvas targetCanvas;
    public GameObject PlayerBlock;
    public GameObject PoolBlock;
    private SupportTools supportTools;
    private GameManager gameManager;
    private List<GameObject> ListPlayerBlock = new List<GameObject>();
    // public ObjectPoolManager objectPoolManager;
    int CurrentTheme = 1;
    public TextureResources textureResources;
    // Enum định nghĩa các loại khối Tetris
    public enum BlockType
    {
        //Khối 1
        o,

        //Khối 2
        oo,

        //khối 3
        i,
        l,
        j,

        // khối 4
        I, // Khối I (một hàng 4 ô)
        O, // Khối O (hình vuông 2x2)
        T, // Khối T
        L, // Khối L
        J, // Khối J
        S, // Khối S
        Z,  // Khối Z
    }

    private Vector3 FirstBlockPosition;
    private float blockSize;
    private float blockScale;
    public int totalStar = 0;
    public GameObject StarPrefab;
    public GameObject ListStar;

    GameObject[,] grid = new GameObject[16, 9];

    public GameObject testblock;

    int[] RandomRange;

    int[] MapList = {11,38,26,14,1,41,22,25,37,2,20,19,29,40,47,38,47,28,47,41,40,21,21,41,25,45,28,26,43,12,6,40,29,3,10,28,21,39,14,37,33,20,30,38,4,8,28,43,20,32,8,38,17,27,45,7,15,2,13,4,12,40,23,8,46,22,45,34,2,29,25,35,36,39,22,42,31,36,23,36,18,31,36,19,15,42,22,13,13,21,21,27,26,12,47,7,6,47,31,15,34,32,4,10,34,15,42,7,10,31,11,5,25,15,4,20,44,24,31,36,19,45,20,22,43,45,9,4,24,43,22,11,2,32,29,26,44,29,42,10,9,16,34,12,44,29,9,9,42,4,4,39,0,40,19,27,20,33,14,32,19,2,14,25,34,40,14,36,47,41,42,9,10,20,23,16,10,30,20,22,39,17,30,37,23,10,7,14,16,9,18,36,9,13,33,18,12,24,34,22,29,43,9,7,28,12,28,45,45,19,6,16,43,14,30,35,34,27,6,26,39,33,20,30,24,16,47,7,24,46,18,29,12,34,15,13,45,20,18,37,45,47,29,20,24,9,26,32,45,14,2,23,29,32,13,41,31,36,2,6,43,40,5,16,43,42,13,11,0,8,6,29,10,42,38,4,43,28,39,46,33,45,23,42,41,47,23,43,31,39,1,23,36,6,6,29,41,24,8,27,7,32,20,34,23,40,33,31,35,12,28,39,25,38,32,20,27,39,31,1,23,25,20,5,23,14,37,19,33,24,22,29,16,11,14,23,14,13,47,29,44,4,42,26,26,38,24,38,9,26,33,5,5,45,44,17,27,24,0,10,17,15,3,30,39,11,42,37,12,45,43,21,21,25,12,33,0,1,28,21,14,7,16,5,47,29,34,47,33,27,36,12,17,25,8,1,37,34,5,20,10,14,31,31,29,24,29,5,17,1,30,46,7,42,9,32,43,17,44,13,17,8,10,24,17,36,18,33,18,34,34,27,30,4,5,47,5,20,9,11,37,18,45,12,35,39,44,2,42,10,8,34,9,17,37,0,26,19,3,8,8,42,14,35,32,38,16,13,3,47,41,34,21,20,1,37,30,42,2,34,32,14,11,9,9,25,32,10,40,5,33,13,39,22,4,35,5,15,39,28,14,28,44,45,27,11,20,19,38,8,0,18,31,37,17,22,13,31,41,30,21,13,40,10,46,5,37,24,27,25,43,32,22,11,6,30,44,46,11,43,40,5,30,33,18,18,38,29,42,9,21,14,11,4,37,38,16,6,7,36,44,21,9,34,46,43,8,44,5,5,33,7,12,7,23,20,46,37,25,18,47,40,28,31,17,44,22,34,22,35,38,46,3,6,24,46,26,28,47,30,26,24,42,27,38,11,7,30,12,44,33,13,8,38,13,15,10,38,32,30,21,18,17,38,33,0,30,2,25,32,42,41,26,1,13,2,15,44,15,9,24,45,29,36,16,12,20,9,14,18,34,25,36,6,28,25,46,40,28,22,23,29,2,1,20,6,15,18,22,3,13,46,21,15,2,30,42,44,3,34,12,42,35,36,31,10,42,32,17,10,28,28,20,27,4,35,9,20,17,23,33,17,15,19,2,3,33,12,12,15,24,27,3,29,14,23,47,31,36,12,25,42,28,47,16,30,15,19,32,23,25,1,31,3,26,40,42,44,26,29,42,33,11,28,12,36,30,23,31,11,21,42,22,14,13,43,13,1,15,7,21,33,29,22,10,39,0,14,43,11,47,25,42,18,6,12,4,22,30,17,30,13,24,30,32,42,34,15,37,8,21,0,9,2,11,33,38,36,33,12,13,37,45,0,30,42,42,22,26,30,18,34,46,22,4,5,45,45,33,24,2,32,30,11,20,7,30,29,41,32,3,19,30,44,8,2,18,23,42,26,28,29,30,22,13,8,43,37,13,21,35,5,11,36,7,43,44,43,38,3,28,24,20,24,19,24,27,27,0,28,15,12,10,28,17,23,18,36,17,8,36,7,42,33,43,42,38,11,46,8,30,32,35,11,26,20,38,5,45,27,25,28,7,6,17,42,11,26,6,10,26,2,25,22,10,37,32,24,32,16,21,39,36,8,29,9,21,27,21,41,41,41,15,6,45,27,19,4,41,41,47,43,46,4,21,47,42,30,3,2,46,32,12,41,0,25,40,9,41,26,17,26,31,0,21,26,42,5,10,12,31,17,5,6,30,2,34,24,14,27,38,31,29,21,28,6,46,38,16,7,41,22,31,47,6,14,3,28,23,34,30,28,25,6,6,32,25,41,16,46,44,18,42,24,37,11,11,23,16,6,19,15,20,18,19,4,28,45,32,44,18,36,7,30,2,6,14,27,6,15,41,26,38,16,4,5,42,32,13,37,7,19,32,6,26,11,16,37,33,40,29,37,9,34,14,25,8,9,39,33,46,22,21,15,17,30,27,4,30,40,24,11,37,11,20,34,34,40,20,4,9,44,25,34,42,12,15,14,45,11,27,23,9,32,23,14,21,28,0,2,35,18,34,32,17,4,2,2,36,37,25,3,4,47,27,32,2,42,29,33,32,38,42,31,17,5,42,7,32,36,28,18,33,23,10,26,27,27,7,23,3,34,47,1,40,22,44,15,9,39,43,20,5,47,35,32,1,36,19,22,46,45,1,15,15,14,25,19,35,3,13,24,23,29,22,15,19,39,13,7,34,33,37,43,3,38,19,8,2,36,9,26,30,36,11,12,36,8,23,21,4,5,20,18,38,16,1,18,2,14,0,38,7,16,37,39,5,29,0,31,11,43,47,32,26,22,46,46,23,47,31,32,5,29,38,18,44,27,41,9,3,27,4,46,25,33,38,0,45,37,21,21,43,21,20,14,31,25,19,3,36,22,22,27,39,25,22,47,2,0,30,31,25,11,30,1,31,41,22,13,35,20,18,38,19,46,23,40,35,0,5,18,10,18,5,29,27,34,25,14,2,34,22,45,17,22,45,5,28,42,41,37,13,33,11,29,16,38,22,47,19,35,42,30,43,37,30,30,17,27,34,4,21,3,35,29,30,38,2,1,12,14,9,29,12,46,5,22,24,1,23,9,29,22,11,25,46,31,26,36,21,0,8,16,11,15,45,23,16,3,17,3,29,21,35,18,33,18,31,44,22,18,7,30,12,4,3,6,1,9,39,11,13,16,29,26,33,7,36,12,10,6,32,39,19,3,13,27,12,3,32,16,33,0,0,39,9,15,2,32,32,38,0,25,20,31,41,9,31,38,37,26,17,33,25,9,23,43,30,9,12,20,44,32,33,26,7,40,10,17,4,18,22,42,26,17,47,17,42,36,32,21,20,10,26,21,6,9,4,17,20,6,44,40,31,2,31,5,21,21,39,1,15,1,27,37,9,0,29,29,46,45,4,29,38,9,16,5,10,17,43,34,37,36,9,16,44,0,30,39,8,17,10,14,20,8,24,30,29,7,44,38,28,40,37,17,20,44,29,45,15,18,15,0,44,5,3,44,34,2,34,32,31,29,47,5,46,15,33,45,35,16,4,33,17,37,4,16,28,12,42,27,47,31,24,39,28,3,46,17,26,27,0,33,13,42,5,8,25,22,36,9,10,25,29,35,16,20,1,12,8,28,23,43,6,43,34,18,41,0,20,43,47,39,0,25,15,1,31,6,32,36,14,43,3,9,16,33,46,23,4,19,1,2,22,8,24,20,1,19,21,39,37,38,34,22,2,36,38,20,28,3,44,14,39,46,10,42,7,20,0,42,33,30,15,44,3,30,31,38,34,45,37,40,20,28,47,0,36,44,23,23,22,24,17,42,46,34,13,30,30,13,0,37,39,24,37,5,28,21,38,16,13,17,46,36,46,4,36,15,35,44,36,43,31,27,43,36,5,6,18,8,45,42,31,32,4,45,43,2,5,46,6,32,18,27,17,37,40,33,0,5,23,15,42,19,4,11,43,26,9,28,39,10,35,7,3,20,29,44,39,10,20,40,4,13,21,36,43,26,0,20,27,23,13,2,43,6,41,36,28,37,26,25,33,0,11,43,1,25,4,28,6,22,25,11,1,44,38,47,0,43,18,38,39,36,25,15,31,37,40,26,33,5,23,26,17,7,26,19,10,32,0,42,37,12,6,5,7,8,18,9,24,3,37,43,18,25,12,5,44,19,36,29,10,44,23,11,19,44,1,8,11,3,3,11,26,33,42,8,6,24,26,9,5,37,37,43,46,36,4,39,43,0,31,25,23,1,46,23,3,38,25,22,9,46,27,41,23,24,16,9,3,6,19,32,26,13,35,24,15,27,17,14,34,9,8,14,5,46,13,31,11,11,37,43,12,5,25,0,33,46,43,20,5,2,34,46,19,29,16,25,29,8,12,20,24,3,35,34,27,29,8,24,46,33,40,1,9,1,3,12,33,22,21,1,9,22,14,44,9,46,34,22,25,1,17,47,41,13,22,33,14,9,13,36,5,18,32,37,6,41,14,30,26,23,13,1,41,9,40,12,35,12,34,8,46,14,47,13,47,15,18,29,26,5,17,34,36,38,10,28,37,30,9,16,28,22,3,35,41,22,22,4,4,7,30,19,8,3,46,37,3,0,18,33,43,23,36,46,15,12,5,25,44,36,40,3,28,1,11,26,7,45,44,16,6,45,28,28,25,5,16,7,15,30,45,27,28,40,33,19,24,44,28,1,12,23,2,41,29,25,6,14,38,45,26,37,3,40,25,36,6,27,43,27,30,45,0,28,22,38,44,36,18,33,37,29,37,19,23,34,8,34,24,4,28,42,36,27,11,11,41,24,34,45,10,34,21,17,44,25,29,38,38,13,44,17,18,42,24,45,31,11,39,36,30,2,17,29,22,11,7,15,16,19,5,23,18,10,14,4,30,12,5,31,29,10,18,8,47,8,1,33,31,37,20,14,8,26,36,8,30,8,3,0,22,4,9,2,12,44,46,24,35,2,3,23,10,46,25,33,37,34,12,40,15,45,15,29,20,22,46,39,22,20,2,29,0,20,44,35,9,28,45,26,41,15,10,46,46,0,21,5,13,29,4,2,41,40,28,37,27,14,45,37,30,12,17,7,38,45,12,19,14,26,22,0,30,4,14,12,23,39,31,12,0,21,39,25,16,19,26,9,11,42,2,40,47,46,42,31,9,6,33,25,28,22,5,9,33,14,36,0,27,1,12,1,44,42,2,11,34,10,9,31,12,25,25,25,19,17,22,6,37,6,11,18,3,25,26,5,33,9,18,4,42,24,39,37,33,26,44,18,10,44,45,19,5,19,43,19,15,46,29,3,32,2,29,26,34,23,22,6,16,16,28,7,26,36,24,26,7,9,14,33,28,32,26,33,21,26,12,25,31,16,14,33,45,34,30,5,42,4,43,21,38,28,35,14,38,34,12,39,4,44,31,38,34,29,5,40,6,47,25,31,28,1,27,38,30,29,40,7,10,24,34,30,10,35,25,38,35,41,21,15,44,47,9,28,9,11,1,21,41,21,21,42,14,35,10,21,36,33,1,3,46,17,39,15,7,7,4,43,12,29,44,21,13,45,40,1,4,3,13,39,29,42,32,26,14,0,25,10,7,2,18,39,33,31,40,41,18,26,14,34,44,39,35,43,7,38,36,44,2,36,26,16,20,38,33,43,21,35,14,12,14,34,19,41,41,45,34,26,2,20,42,38,16,3,11,8,19,36,15,16,33,38,7,14,3,5,32,35,21,19,36,12,32,39,23,36,40,22,2,1,23,38,4,32,4,22,40,34,39,27,20,7,3,6,32,23,13,5,30,7,18,3,45,46,31,42,20,18,2,12,21,41,25,8,11,31,17,41,6,39,22,32,42,18,4,31,34,39,26,40,23,39,35,45,9,6,2,22,43,9,31,9,32,28,31,31,41,26,7,22,12,36,1,46,26,26,31,47,14,15,11,38,45,40,14,19,43,13,25,18,13,2,28,23,38,7,19,11,41,26,17,12,34,25,47,5,46,10,39,40,7,13,18,10,39,15,34,12,39,27,42,11,13,30,8,18,13,4,18,14,45,44,46,36,9,25,33,21,46,33,45,37,10,46,38,38,40,5,12,32,5,5,29,42,30,23,47,35,29,2,1,40,40,29,37,22,11,6,3,9,0,19,43,5,3,32,6,19,3,28,44,18,29,22,23,26,39,4,17,1,15,29,30,22,41,37,8,14,22,34,5,16,34,37,38,34,20,10,23,13,46,8,34,37,35,41,22,8,42,42,24,12,17,44,44,26,47,21,2,29,22,28,33,7,29,20,11,31,33,46,9,30,29,26,23,30,35,41,34,36,28,25,5,24,41,7,38,19,13,22,28,7,30,39,0,31,42,30,13,34,4,33,20,18,30,20,14,8,33,47,36,13,27,47,6,43,15,0,16,42,34,5,9,23,26,29,27,6,36,21,3,15,25,12,19,12,29,25,2,32,40,0,40,0,11,28,17,8,47,39,11,29,39,25,27,5,23,9,28,6,10,38,8,38,31,45,26,23,7,2,30,10,39,42,1,1,9,2,17,22,21,4,29,37,20,14,15,17,13,6,36,34,31,4,7,1,17,40,27,22,23,40,7,35,35,4,33,43,10,28,44,7,23,35,47,11,5,1,47,2,39,19,2,27,27,29,39,37,16,13,40,35,20,21,17,33,24,6,25,17,44,14,10,10,33,16,19,39,36,29,8,19,16,39,28,2,43,12,40,20,34,3,25,35,46,7,22,4,17,8,29,23,45,47,31,43,26,44,19,26,38,13,27,34,15,17,17,25,9,46,33,21,22,19,30,12,15,20,37,45,45,30,4,20,42,10,4,24,26,40,10,44,0,31,23,30,41,25,16,2,9,17,30,2,36,16,9,36,38,33,31,43,3,22,5,6,30,14,8,44,9,14,44,7,45,21,42,34,2,34,45,7,46,22,19,8,19,32,37,33,30,30,34,46,24,16,22,11,20,3,18,24,47,43,11,17,21,29,17,47,45,13,35,1,25,10,27,35,16,13,32,10,32,37,6,13,10,24,14,42,8,46,32,15,40,31,37,46,36,7,30,24,24,32,5,4,25,31,31,24,9,31,21,27,23,18,45,36,47,25,14,5,0,24,7,38,17,39,29,32,2,25,4,26,18,41,17,43,21,29,38,42,42,34,5,44,47,38,5,31,27,12,19,5,4,43,24,31,12,47,42,10,15,42,42,17,10,28,41,8,27,40,5,30,34,3,19,5,24,12,27,34,14,9,29,2,28,39,18,0,41,47,19,20,13,21,15,30,33,19,16,42,4,17,44,18,37,29,40,27,18,36,25,43,25,16,4,33,30,47,1,14,33,27,6,38,21,7,21,12,1,47,18,30,42,17,11,17,2,24,41,24,6,18,38,13,14,2,19,2,32,35,47,27,38,9,44,11,19,46,9,3,3,25,9,47,26,38,43,16,6,11,29,47,40,22,46,17,42,42,19,34,20,39,11,47,41,13,3,47,28,16,7,46,29,17,2,20,13,22,30,43,34,34,37,11,32,34,43,28,15,32,33,9,16,13,7,43,40,19,21,12,13,0,2,34,22,15,12,9,1,23,5,44,2,40,21,39,36,5,46,5,38,2,37,8,41,5,1,21,5,9,47,36,3,26,46,32,1,21,46,31,36,3,6,11,47,14,32,8,1,36,17,3,7,0,40,35,40,1,36,21,33,23,17,38,18,9,38,16,9,46,47,4,2,30,44,8,7,9,30,40,42,7,1,0,28,2,5,1,26,44,36,42,39,30,8,47,44,10,14,36,36,45,0,37,23,32,8,46,45,39,23,44,10,32,24,7,18,13,22,30,19,31,2,12,2,32,45,15,20,6,41,45,38,16,38,16,20,39,45,12,33,4,46,12,21,5,25,13,19,23,10,33,31,17,46,32,12,31,20,30,2,5,24,31,20,20,38,47,10,23,36,28,6,1,35,46,33,10,27,0,47,30,16,30,27,23,6,18,22,27,25,6,21,9,44,11,17,10,29,0,46,40,0,42,18,12,43,19,33,17,27,5,31,17,45,27,11,46,44,4,23,28,33,10,34,45,5,26,36,20,29,46,4,6,11,28,44,1,42,47,46,25,21,34,40,22,41,46,7,16,40,36,46,46,25,27,39,8,6,13,30,37,31,34,39,37,19,38,11,39,22,47,30,41,42,45,42,35,47,9,44,40,6,46,17,22,37,29,22,13,10,3,30,38,17,2,34,15,10,35,0,42,41,7,18,42,32,0,11,43,11,32,23,0,41,20,44,25,38,40,4,41,31,10,28,1,13,47,9,19,12,24,4,20,12,40,25,10,35,18,4,0,13,39,18,2,16,38,0,36,46,30,21,35,18,16,7,7,3,31,22,11,20,10,11,25,35,12,7,21,30,34,12,7,41,32,17,38,42,40,42,3,16,24,7,47,19,2,5,36,21,2,17,22,29,10,15,41,46,15,12,24,16,47,42,35,42,47,24,10,17,19,43,25,30,18,9,0,45,3,38,38,36,30,41,45,35,25,43,30,7,3,45,14,41,27,17,13,3,4,10,35,21,44,12,14,35,17,23,35,0,33,39,21,5,1,32,23,30,26,19,30,44,8,45,4,24,6,47,45,45,10,43,28,40,43,39,29,0,32,4,6,35,16,14,12,40,24,10,38,46,41,45,24,20,7,32,26,15,3,3,43,0,27,27,40,8,1,12,47,1,18,23,9,42,29,31,42,24,0,28,44,6,27,11,32,36,32,12,34,39,42,2,21,21,30,46,31,0,32,10,43,0,17,22,3,29,39,46,30,22,10,35,28,42,36,37,2,35,17,14,36,36,13,2,11,15,23,7,3,30,7,19,43,35,34,7,30,20,44,21,24,37,29,27,25,41,29,1,20,30,44,18,27,15,47,10,3,19,45,43,18,34,3,33,18,18,11,17,11,8,23,16,1,11,21,33,46,8,31,13,20,34,34,1,3,3,44,13,25,20,40,39,15,11,40,35,6,29,24,16,6,34,6,44,16,47,27,40,46,45,18,26,29,19,34,14,8,22,15,29,23,42,0,30,42,5,6,13,13,31,8,24,33,13,26,17,33,18,25,37,16,38,41,32,9,47,14,23,11,46,39,15,43,14,30,35,28,1,39,7,23,36,40,6,20,36,20,34,32,45,10,7,4,45,29,47,8,36,18,34,5,5,12,4,1,19,23,15,1,34,29,15,25,0,39,7,47,34,3,8,18,20,0,36,18,45,9,2,33,36,20,16,36,36,8,28,1,5,38,29,5,44,7,0,22,2,19,36,33,3,47,15,8,20,11,16,32,1,2,29,17,10,26,43,23,24,1,15,26,23,27,5,34,45,28,2,24,37,32,36,28,12,44,41,37,16,41,11,25,46,30,8,25,11,4,6,5,13,17,27,18,23,0,12,8,34,28,10,12,18,44,4,9,27,17,11,9,3,5,14,44,14,26,27,42,9,38,9,34,22,44,45,3,22,29,0,38,1,31,44,14,31,1,12,14,1,5,47,24,46,36,46,2,18,39,34,29,41,11,34,44,20,9,18,32,14,46,18,46,12,11,13,18,19,31,33,3,37,0,39,34,11,21,46,35,18,3,10,26,22,22,25,9,29,13,22,5,10,1,44,32,40,3,16,42,37,7,38,17,18,34,14,34,33,1,39,47,23,14,31,37,37,29,40,2,12,0,9,5,31,10,43,34,18,12,37,29,5,9,34,32,43,11,43,6,31,7,40,15,19,22,29,41,24,16,4,22,45,18,7,40,28,44,36,16,25,25,23,11,4,27,12,20,40,1,1,38,47,1,27,7,38,2,6,16,2,26,3,29,45,27,20,20,31,14,4,3,36,13,11,16,42,15,17,22,12,22,47,28,19,21,1,33,39,46,34,35,19,25,27,26,4,45,2,46,3,21,4,8,36,1,9,43,4,38,18,32,18,43,36,20,27,21,39,44,35,18,23,47,46,12,9,5,21,42,17,18,42,9,46,32,36,28,42,24,42,33,10,0,43,13,3,9,20,26,46,40,23,26,37,12,9,18,20,17,26,23,18,40,40,8,42,12,28,24,24,21,41,42,3,24,5,28,6,25,3,45,29,45,7,12,1,12,26,17,18,36,25,47,43,4,35,44,39,12,38,18,44,36,28,6,2,27,27,22,18,46,4,3,19,42,40,44,1,10,22,33,0,38,28,19,14,47,18,24,30,11,20,47,38,7,29,29,14,44,34,6,40,29,23,19,34,25,19,31,26,8,25,34,5,23,17,13,18,19,39,23,31,15,6,41,19,25,37,27,34,23,20,14,32,46,4,6,1,44,16,34,36,21,11,5,15,1,9,0,24,4,16,27,2,8,29,45,19,15,19,43,33,33,33,38,42,47,20,17,10,17,33,13,7,29,3,14,17,35,18,5,18,20,17,28,26,33,16,39,22,40,46,27,38,17,12,18,12,15,34,34,14,16,42,22,19,37,0,34,18,29,25,26,26,3,27,44,34,27,26,0,7,2,29,19,11,10,28,36,42,37,23,1,24,22,6,5,21,14,2,45,23,35,27,42,7,23,45,11,12,42,4,25,2,31,34,23,43,21,13,3,30,28,19,7,34,36,13,24,34,40,20,45,34,35,0,17,38,22,35,44,36,45,11,28,47,20,35,36,4,34,45,24,19,16,1,42,28,13,8,41,22,40,45,16,3,43,43,6,21,10,42,12,26,16,47,6,31,28,12,16,21,40,10,37,44,47,42,35,37,15,38,24,46,23,19,7,19,1,47,36,9,44,20,5,40,33,15,46,5,27,6,28,9,35,1,25,22,33,3,32,12,40,27,32,15,42,41,2,19,16,36,45,16,9,37,45,30,9,37,44,22,44,32,6,44,7,6,9,46,42,31,24,0,46,23,44,18,29,16,1,5,40,38,18,36,42,40,33,37,17,2,32,43,35,24,40,18,14,3,34,9,31,8,40,16,28,30,40,10,32,42,0,22,20,13,35,12,32,9,5,35,22,11,20,43,0,36,39,41,30,20,33,21,33,31,47,32,36,27,36,16,3,13,39,16,31,41,19,15,14,44,8,31,43,38,27,36,5,22,46,19,5,6,45,39,2,42,25,3,15,16,33,2,27,45,17,37,26,22,34,33,30,28,31,46,10,17,22,27,27,42,43,44,24,23,41,40,42,44,35,14,35,43,0,46,18,39,0,2,43,1,13,27,17,11,2,7,30,16,35,31,2,30,43,28,2,47,3,30,27,7,44,22,29,22,43,18,38,19,46,24,18,45,2213,46,31,47,18,0,38,9,0,1,37,15,45,20,5,39,13,32,39,35,26,37,4,15,27,27,44,10,1,37,25,32,36,33,6,30,37,15,24,33,41,2,28,34,9,12,0,13,32,13,18,10,13,14,27,0,27,41,30,46,13,18,17,44,4,11,5,25,30,18,21,17,1,25,21,4,8,34,15,2,26,28,12,0,28,26,25,28,35,41,21,24,42,43,39,20,27,28,47,4,11,5,34,43,23,11,12,33,44,31,1,47,24,3,23,32,17,37,9,12,16,6,5,1,46,23,46,8,47,27,24,39,30,33,14,39,46,16,39,19,36,17,35,37,2,22,16,14,4,40,11,28,43,19,47,15,23,32,18,20,26,27,39,5,25,41,17,31,28,40,34,7,39,28,21,9,0,3,16,7,30,41,26,6,10,39,20,39,23,32,0,43,7,13,43,7,3,46,0,30,40,19,18,23,35,0,29,19,10,34,9,26,21,12,47,38,25,0,1,18,39,18,20,43,21,29,10,27,19,29,35,13,1,32,26,8,20,11,39,8,26,2,39,41,13,29,16,34,2,25,18,39,32,26,20,4,29,1,39,46,0,2,16,35,14,9,42,21,17,32,38,39,22,40,12,26,17,41,25,19,19,41,22,24,30,16,40,28,11,34,39,16,33,7,0,35,45,26,40,13,19,10,15,2,20,42,24,10,23,43,39,20,20,28,13,4,45,39,27,42,24,24,39,1,16,5,9,22,10,38,7,41,25,20,6,25,41,21,30,1,13,8,36,26,46,34,9,18,13,22,12,30,34,7,35,29,32,29,46,23,12,14,16,28,19,34,2,1,11,7,9,36,15,18,8,19,33,22,3,35,16,27,12,26,18,24,3,12,34,29,8,24,13,27,41,7,43,5,36,28,33,32,35,9,5,30,28,41,21,6,36,26,42,23,20,43,38,14,27,9,5,29,30,23,31,43,29,19,38,5,12,14,4,47,24,20,28,2,23,33,24,38,40,9,8,18,32,6,2,27,30,26,8,15,23,22,0,38,6,2,40,43,46,38,5,14,9,32,26,46,31,8,26,2,32,36,19,8,37,16,21,41,18,25,30,46,31,26,15,37,33,28,4,3,5,23,2,39,44,29,15,24,44,31,7,33,28,21,6,17,3,34,34,19,34,45,7,3,33,0,1,12,2,32,26,41,27,29,28,2,25,8,22,1,7,17,37,42,39,6,11,0,35,13,0,19,21,31,11,22,12,34,28,45,24,2,43,12,15,39,37,0,27,17,30,11,28,9,38,17,28,27,9,16,31,11,45,16,29,29,7,23,7,12,23,22,44,30,21,43,14,7,20,25,28,7,5,23,42,11,20,13,11,20,30,30,33,38,19,41,10,22,36,5,8,21,30,46,30,26,3,43,35,38,12,38,13,38,23,14,36,26,12,25,21,40,9,4,7,15,8,20,12,35,34,14,32,21,20,23,29,22,41,10,9,17,30,23,34,21,26,37,8,40,33,42,38,24,12,11,6,45,46,6,1,45,16,25,33,46,42,38,22,18,26,2,17,12,41,23,14,15,40,31,24,40,35,24,4,33,14,14,47,11,24,29,4,10,0,19,8,7,44,9,17,4,42,1,36,13,33,25,30,35,36,5,37,40,25,27,7,37,25,8,18,4,27,25,43,11,30,27,27,6,34,24,20,0,28,3,28,35,37,1,1,6,46,18,12,43,17,18,37,23,29,31,19,37,6,12,10,11,11,47,28,41,4,37,46,19,20,4,7,0,18,3,14,42,22,13,37,11,5,14,31,3,27,21,1,46,42,8,8,15,24,33,2,8,6,43,41,20,34,27,17,42,16,0,7,0,5,46,3,11,5,2,15,43,20,10,34,0,37,16,34,3,43,22,41,23,11,45,21,17,3,29,47,39,26,3,38,42,22,23,4,30,29,41,29,3,18,13,29,28,47,5,41,26,38,20,44,10,0,44,3,12,16,41,46,25,46,4,23,13,31,16,18,10,10,35,33,4,20,25,28,22,32,34,30,34,26,20,29,18,21,36,33,11,19,5,6,0,37,15,31,27,21,31,6,19,11,4,40,41,27,45,0,46,14,43,39,16,44,36,24,13,7,16,8,7,42,35,18,41,10,0,12,34,13,23,43,12,15,8,35,13,32,7,7,11,43,41,17,16,28,10,8,16,44,12,14,22,5,16,16,45,20,19,33,25,39,39,12,12,17,38,10,33,42,8,23,10,43,8,40,23,38,11,16,28,16,45,31,41,33,39,47,47,30,47,40,42,14,42,38,11,5,47,29,42,16,10,30,33,31,30,24,1,14,40,28,2,44,38,17,17,1,24,44,6,0,45,31,7,30,6,24,11,35,1,7,18,30,3,26,37,38,42,5,18,34,7,27,18,31,44,41,38,43,0,44,9,20,0,19,13,24,32,35,7,0,14,3,9,27,21,18,11,6,0,23,31,16,17,16,35,14,12,37,12,21,31,31,42,12,45,45,3,16,46,45,25,0,24,47,12,11,22,17,33,1,19,6,16,2,17,41,15,40,1,36,37,27,14,36,0,38,8,10,10,11,41,8,10,33,13,3,14,5,36,31,16,46,20,11,39,43,13,42,28,14,15,43,42,33,28,11,45,3,37,43,12,19,32,4,17,14,41,1,36,22,27,0,1,42,22,11,5,45,38,39,31,31,31,0,29,34,25,21,15,16,47,1,40,26,47,30,27,14,11,32,25,39,32,1,43,45,31,16,7,23,11,9,22,16,21,35,43,2,39,41,7,18,20,7,9,45,1,36,41,10,21,41,10,26,10,28,30,42,21,1,24,44,31,27,34,21,34,45,30,14,35,32,37,45,2,14,3,3,10,10,11,20,18,10,33,8,27,9,4,13,29,3,2,36,5,40,40,28,11,42,16,8,32,12,10,8,39,47,39,19,35,5,2,10,11,4,3,43,37,41,25,28,46,7,8,31,34,45,36,16,26,35,9,12,42,47,35,27,6,30,35,38,35,14,25,24,21,29,18,12,39,14,8,3,27,9,39,7,17,18,15,19,29,18,8,26,45,47,33,16,47,20,28,17,45,10,14,42,19,38,32,19,25,7,45,29,33,36,10,33,45,25,30,17,24,26,12,36,39,46,25,17,45,30,47,18,37,14,43,33,17,31,15,41,5,38,11,0,8,42,29,22,37,36,31,10,12,8,29,27,27,36,44,7,15,35,16,45,47,29,45,5,45,21,13,47,43,46,8,41,32,45,32,31,3,24,2,16,20,1,23,30,13,8,10,47,30,17,44,44,36,39,9,14,45,42,34,19,30,4,19,40,36,36,3,34,32,12,26,25,39,32,9,18,24,15,39,4,1,18,21,29,23,27,14,42,22,0,35,39,13,40,10,23,35,34,27,35,35,16,19,42,9,9,43,0,26,30,24,29,42,17,39,37,0,33,1,18,9,37,18,28,45,21,46,17,35,43,21,15,46,47,30,34,25,5,38,5,45,28,22,18,13,3,1,10,15,37,41,37,36,0,5,27,40,37,10,26,28,33,1,29,44,0,4,17,11,36,38,8,39,44,41,4,19,38,0,19,41,14,15,20,20,14,40,39,31,36,5,25,23,28,46,12,10,13,31,29,40,5,30,12,37,32,24,4,43,19,1,6,27,28,5,16,16,46,30,2,42,44,44,2,18,22,23,44,5,19,39,23,5,4,36,20,40,30,32,33,12,44,28,16,31,23,14,3,18,17,26,14,7,2,42,22,36,12,26,5,6,26,6,26,27,17,31,19,26,4,40,37,43,2,38,0,40,20,27,19,21,32,38,35,34,35,42,21,44,32,14,16,31,39,33,0,47,10,9,15,36,3,7,44,40,6,32,13,25,42,6,29,37,24,33,18,9,24,3,23,12,44,36,43,7,3,18,11,27,40,10,28,36,16,31,32,43,13,40,6,21,22,40,18,18,12,36,8,6,45,14,45,40,0,17,25,6,1,34,13,31,22,21,22,47,3,12,1,42,20,40,19,4,43,45,40,29,29,31,18,42,23,47,32,15,24,41,7,20,3,46,10,45,12,28,44,36,46,23,11,25,17,2,21,11,44,38,9,4,39,5,34,43,33,46,0,5,6,23,27,43,7,2,17,30,42,46,47,13,28,26,36,46,14,45,12,8,27,15,26,3,41,18,34,20,11,15,21,27,12,22,44,31,1,28,33,40,37,41,7,36,47,46,14,24,15,25,1,22,42,6,20,11,17,22,3,24,14,34,6,17,14,13,2,23,4,27,23,44,0,10,45,19,40,19,3,27,40,1,30,45,2,27,26,4,37,19,43,46,1,21,8,21,39,43,5,15,21,33,1,7,29,12,12,34,2,25,46,1,8,39,2,35,22,7,41,3,8,11,19,11,36,0,18,46,21,47,26,5,41,6,34,23,11,0,35,37,24,32,13,21,24,4,12,46,29,38,20,29,21,41,8,44,34,35,30,19,5,33,30,2,13,0,43,26,30,36,43,21,35,30,13,8,32,14,11,26,3,31,30,45,8,17,45,36,40,17,17,31,37,31,0,27,20,35,43,28,34,46,35,17,29,14,10,45,46,0,3,8,30,5,25,45,2,11,37,32,36,18,9,1,33,37,2,8,8,47,8,24,41,11,13,46,28,34,5,17,7,31,42,41,26,19,28,20,36,6,2,22,24,19,24,38,15,17,18,23,2,30,14,24,35,34,36,39,24,27,25,10,24,4,22,31,10,29,19,24,11,3,42,47,11,6,7,9,24,23,4,7,39,39,46,29,28,11,25,39,34,36,35,31,33,20,21,10,19,41,13,11,19,6,9,13,27,9,38,29,32,1,33,29,20,3,18,41,41,47,20,2,14,24,23,33,9,31,0,37,28,9,39,7,24,35,32,45,24,3,44,13,35,13,43,40,24,15,4,3,39,22,28,0,15,7,41,44,10,7,46,14,0,23,29,44,6,6,16,5,21,47,14,25,41,3,31,33,24,31,12,42,1,31,35,7,39,35,11,33,42,0,22,5,9,39,6,31,21,2,19,21,38,28,8,8,24,15,5,38,13,4,24,8,38,18,31,46,15,4,16,44,32,24,22,12,29,38,41,9,19,37,45,31,6,46,15,5,12,32,16,44,40,6,44,17,28,19,17,24,21,45,13,26,44,3,33,37,46,20,42,26,4,4,6,22,7,1,3,42,46,12,18,14,28,26,22,22,2,16,28,15,8,12,36,26,3,7,7,38,11,18,32,5,1,10,8,47,22,29,13,47,29,3,32,0,8,33,45,17,36,0,24,33,28,25,1,11,0,38,41,11,9,3,44,24,13,37,38,3,41,1,4,4,14,25,3,17,45,11,19,45,5,10,45,6,37,20,12,10,46,20,5,22,34,14,23,5,37,4,10,29,31,34,23,47,23,4,10,36,45,4,47,32,7,38,21,3,43,16,11,7,16,43,34,10,0,34,11,4,33,15,41,30,16,45,41,13,25,2,22,30,5,33,35,22,21,22,11,21,37,9,33,34,32,43,46,17,27,33,45,18,33,9,11,34,20,21,5,42,23,4,12,15,34,29,16,23,14,40,32,24,17,4,2,35,34,33,23,37,28,35,43,31,36,5,35,7,7,18,39,20,18,8,11,45,36,24,5,17,6,3,17,31,20,38,17,32,12,41,19,26,35,31,7,19,38,46,39,10,5,16,41,47,22,42,6,15,30,20,27,21,43,11,18,9,33,5,41,25,42,6,39,34,14,19,3,3,11,38,4,41,28,36,16,12,43,35,24,46,37,7,25,9,37,15,35,23,33,15,25,34,28,20,14,39,34,34,9,23,25,43,35,36,39,40,1,29,20,18,31,15,18,14,6,27,10,45,27,3,42,20,32,12,19,26,25,6,12,37,4,0,10,14,46,46,44,11,34,27,6,15,3,8,18,3,8,44,0,21,16,4,20,40,45,11,39,31,10,2,24,41,5,8,33,20,45,28,23,46,16,29,15,47,18,20,30,19,46,32,38,23,3,13,47,1,18,31,28,36,10,40,41,7,11,26,8,15,40,40,17,35,41,31,2,7,20,10,35,33,47,27,47,21,2,0,40,9,24,26,25,46,39,8,32,5,1,47,28,8,17,12,11,40,14,11,28,44,39,19,6,42,39,27,37,32,14,34,0,36,3,34,17,41,41,14,41,9,40,29,22,21,6,39,44,20,21,42,26,4,28,39,39,24,20,38,10,20,45,40,24,15,23,32,17,16,14,3,16,14,36,27,24,30,11,41,15,39,27,47,11,37,2,19,6,13,3,42,47,32,39,6,28,22,12,42,17,43,13,37,39,4,23,24,22,28,14,18,0,34,20,15,13,26,46,41,6,14,16,29,30,38,10,9,43,11,32,35,41,22,19,26,20,5,44,12,14,10,28,32,41,38,14,36,15,6,12,47,30,5,17,10,4,14,14,13,38,27,9,19,21,32,33,6,12,2,33,34,10,17,24,16,13,40,42,37,20,24,12,42,44,40,32,5,12,23,43,13,39,4,36,30,8,1,6,47,31,37,44,25,34,24,17,38,41,19,25,18,43,43,32,14,18,32,12,13,35,46,37,15,2,35,0,18,20,30,17,33,25,7,7,22,12,14,25,32,11,15,19,25,35,3,35,16,35,27,5,0,29,36,9,15,46,38,4,19,25,45,43,28,2,21,44,10,37,4,11,44,9,43,1,9,3,38,33,40,35,20,34,39,18,13,6,24,20,24,31,18,47,11,28,32,13,33,10,19,42,23,15,20,19,10,31,45,0,18,34,36,47,35,0,19,8,28,47,41,14,12,30,10,45,29,8,31,18,1,9,37,19,34,13,19,2,11,6,24,47,32,19,8,35,2,12,21,22,3,15,45,1,43,36,38,28,9,19,36,23,3,30,37,17,31,35,28,30,29,5,24,15,25,39,7,25,39,19,42,34,19,12,46,44,35,11,3,25,2,21,13,12,28,45,47,27,34,17,22,20,3,8,41,0,42,3,1,23,2,18,10,32,13,24,29,22,1,13,47,42,32,10,8,25,43,25,6,31,8,9,20,29,23,14,23,43,45,22,47,33,6,31,13,34,17,1,31,29,24,28,0,8,29,11,42,0,12,20,21,27,42,7,33,24,14,13,1,1,36,24,32,45,19,43,44,3,46,15,42,8,31,46,25,42,38,38,5,27,39,18,26,40,39,1,30,32,19,7,25,45,30,27,2,34,17,13,14,35,29,40,1,15,32,19,41,10,10,16,2,36,35,6,5,16,15,29,28,17,33,35,47,5,30,42,16,41,37,7,38,47,21,12,16,19,15,36,5,43,42,36,26,11,44,41,3,7,40,34,42,22,30,30,15,26,35,29,3,7,10,0,41,38,33,39,18,21,14,14,12,3,18,25,33,12,28,18,36,23,27,34,38,33,6,13,10,25,7,3,27,28,41,41,2,23,35,26,3,14,38,24,1,7,18,8,46,24,18,41,18,28,12,40,9,18,45,20,44,40,31,26,35,9,11,27,39,4,26,35,17,47,31,1,47,1,23,22,31,24,25,6,12,40,2,9,12,16,29,18,17,39,13,42,35,21,34,5,22,3,17,11,19,23,9,24,12,9,41,30,20,14,14,46,1,43,14,45,35,32,8,4,47,45,34,34,5,17,9,13,8,23,8,12,11,21,0,16,39,6,24,13,11,23,32,26,38,20,4,30,21,35,19,37,7,4,13,13,46,23,0,37,21,0,42,13,1,7,32,7,7,2,7,14,4,18,19,22,24,35,17,34,12,2,27,40,34,38,28,1,21,20,33,13,13,7,4,6,26,11,22,26,9,8,35,1,1,25,18,7,35,40,41,18,20,36,28,0,46,15,18,15,6,40,30,29,22,14,30,17,29,22,16,11,14,31,19,7,16,27,43,35,47,27,2,45,30,43,35,45,5,28,31,29,26,28,21,46,2,34,25,15,45,47,34,35,18,21,29,8,27,1,44,47,11,33,37,30,32,25,5,10,6,3,37,47,29,9,6,16,30,38,9,38,30,45,7,12,46,17,18,20,3,15,9,18,27,13,17,37,5,45,47,30,35,17,33,0,17,12,21,16,26,14,41,39,45,20,9,20,19,39,11,37,22,27,8,40,2,12,30,20,45,5,15,19,26,36,9,36,30,4,45,42,1,13,38,19,42,32,12,10,27,12,7,36,28,46,3,32,44,34,40,24,46,46,30,6,46,20,43,45,31,41,23,28,45,47,9,12,24,31,22,12,32,16,39,12,11,43,20,26,27,0,24,25,12,39,11,44,35,5,38,7,2,30,3,33,28,47,20,16,28,37,41,17,15,13,46,8,22,45,34,0,39,44,39,20,34,30,21,27,33,26,26,36,31,36,12,36,2,22,4,11,46,45,33,40,26,32,12,8,36,39,45,9,47,46,33,40,47,3,11,18,9,9,21,27,23,31,3,20,33,25,26,38,32,46,26,46,1,0,27,36,34,35,38,6,13,25,21,34,45,8,24,36,38,46,26,19,11,27,42,5,11,19,38,40,28,17,44,0,35,3,18,42,11,27,16,5,36,36,9,2,8,33,7,31,18,25,32,15,18,39,0,13,7,41,36,7,40,6,23,15,5,7,15,41,3,14,45,37,40,38,5,41,10,5,25,25,28,33,4,13,1,22,10,40,27,24,6,39,41,9,14,21,14,32,9,14,1,9,12,37,5,16,3,16,35,33,26,39,17,4,24,5,30,26,39,12,39,6,30,9,7,32,38,22,23,28,19,10,38,21,44,45,17,42,41,34,14,0,39,39,9,47,23,24,30,26,18,46,38,13,24,19,6,27,1,47,33,9,34,25,8,38,1,42,3,22,4,14,35,20,41,46,47,3,1,35,14,19,45,10,0,20,16,33,29,41,2,27,4,0,38,23,4,9,25,16,0,0,34,21,21,31,40,6,7,17,9,47,39,40,17,46,45,5,11,10,45,8,18,37,9,25,39,8,25,8,17,22,42,34,47,47,27,42,17,24,3,32,39,1,8,36,32,16,7,25,44,31,20,33,2,20,22,15,44,15,21,46,29,46,41,6,9,13,10,31,40,29,47,38,6,3,12,27,19,30,14,41,29,35,28,26,42,15,3,31,6,8,36,22,45,32,37,8,4,23,24,22,47,25,31,11,6,14,26,0,1,39,38,6,24,29,13,39,39,39,44,2,38,38,38,22,18,27,23,36,1,10,4,25,18,22,37,37,8,6,28,22,19,29,44,1,22,39,6,17,34,18,0,36,40,45,15,28,8,29,7,35,47,38,1,5,6,27,41,1,21,19,42,8,22,21,13,1,38,36,23,9,34,47,13,16,33,35,13,34,5,45,17,20,14,25,44,14,10,3,40,46,44,22,12,45,15,35,3,9,18,40,41,17,46,9,13,19,47,18,29,9,20,40,31,15,23,23,21,30,22,22,45,40,35,43,42,38,3,18,42,7,1,13,39,41,26,27,34,44,41,22,22,46,0,15,13,4,32,9,13,35,18,3,28,24,45,38,36,4,1,26,14,12,31,45,44,42,3,11,34,11,2,31,2,8,22,14,35,36,12,7,16,32,17,33,44,46,21,41,46,3,43,44,42,39,42,28,18,34,46,26,42,26,20,35,16,42,36,29,6,37,3,37,9,4,8,16,3,17,7,43,27,12,26,22,46,11,26,30,40,12,6,9,31,47,24,14,19,14,38,14,22,41,42,6,19,12,43,26,45,47,20,39,20,17,47,21,14,41,25,31,0,20,41,19,7,7,39,38,31,36,41,8,34,28,11,15,20,17,4,12,43,38,40,12,45,8,37,47,44,10,20,22,4,19,31,37,3,29,39,31,37,29,0,3,3,14,32,41,14,38,27,4,21,20,14,46,28,2,27,1,47,41,44,44,31,22,25,33,41,46,40,0,32,39,5,46,35,36,29,36,35,10,6,6,45,21,32,29,32,22,33,24,14,17,29,8,46,14,23,31,39,39,12,19,10,31,11,18,18,11,17,39,36,40,41,26,47,5,5,14,20,3,10,6,8,41,41,19,31,35,5,3,23,33,21,16,47,20,23,33,39,23,23,23,22,37,32,26,1,3,14,23,3,28,38,12,30,10,19,22,47,47,32,23,38,41,6,38,12,31,23,8,30,23,16,35,20,6,42,31,6,13,16,10,33,23,30,28,15,10,25,17,33,42,2,36,35,8,41,9,33,40,38,3,40,8,24,0,9,43,40,46,46,37,20,16,38,40,31,20,24,8,6,40,17,4,40,43,4,33,11,27,28,18,43,5,13,38,8,13,30,3,47,26,31,34,29,9,3,29,13,34,43,20,31,13,2,19,4,19,40,37,17,28,3,47,28,38,0,13,25,2,12,7,17,35,5,2,36,42,30,43,10,10,12,8,32,35,13,11,9,34,22,11,10,35,3,17,25,42,39,23,30,20,22,26,3,5,19,37,22,16,7,7,21,41,31,32,5,33,17,27,34,9,33,19,0,21,36,26,36,39,45,6,15,33,28,30,31,25,32,36,30,31,8,0,22,8,47,22,25,31,39,24,34,14,17,36,12,14,43,31,33,28,30,25,10,34,9,38,31,44,32,17,23,30,44,4,6,14,37,9,15,0,41,16,1,44,27,5,19,22,15,34,31,16,38,5,9,38,2,29,2,46,1,30,27,2,31,31,39,29,14,5,38,11,14,28,39,20,32,3,3,14,11,4,43,10,34,22,30,7,14,35,17,44,19,9,27,10,36,43,15,24,46,33,32,22,22,1,42,19,46,3,32,18,18,4,1,2,23,15,3,28,7,19,34,10,37,6,12,33,27,47,14,40,6,33,18,45,47,0,16,11,25,17,9,38,39,28,6,4,26,6,5,13,30,35,46,26,33,30,10,11,16,25,40,26,3,29,45,7,25,1,47,37,42,18,8,19,14,5,5,25,19,46,15,37,35,45,26,43,0,22,47,7,45,14,20,23,11,29,28,47,47,7,47,47,35,1,7,14,40,4,46,33,0,27,18,0,6,38,29,9,33,36,38,18,28,21,10,3,33,13,39,15,9,12,22,18,27,28,7,30,4,7,28,47,24,47,39,30,30,16,15,36,13,12,44,36,30,14,7,41,11,33,29,38,36,37,22,25,17,28,26,24,46,29,2,23,10,5,16,43,28,42,42,5,29,20,18,33,11,0,11,14,4,28,43,1,35,41,21,18,1,16,2,9,26,26,24,34,43,0,11,9,22,12,8,41,0,7,25,4,13,36,26};
    void Start()
    {
        supportTools = GetComponent<SupportTools>();
        gameManager = GetComponent<GameManager>();
    }

    void Initialize()
    {
        gameObject.GetComponent<SupportTools>().Initialize(FirstBlockPosition, blockSize);
        PlayerBlock.GetComponent<Movement>().Initialize(FirstBlockPosition, blockSize, MapFrame.transform.position.y);
    }


#region Spawn Player Block
    public GameObject CreateTetrisBlock(BlockType blockType)
    {
        GameObject tetrisBlock = PlayerBlock;
        tetrisBlock.transform.position = Vector3.zero; // Vị trí bắt đầu của khối Tetris
        tetrisBlock.name = $"{blockType}";
        // Tạo các khối con dựa trên loại khối
        List<Vector3> blockPositions = GetBlockPositions(blockType);

        // Tạo các khối con từ prefab và gắn vào khối chính
        // int aa = 2;

        foreach (Vector3 position in blockPositions)
        {
            int randomTexture = Random.Range(RandomRange[0], RandomRange[1] + 1);
            // if(tetrisBlock.transform.childCount == 0 || tetrisBlock.transform.childCount == 2) randomTexture =2;
            // else randomTexture = 1;
            // int randomTexture = aa;
            // aa++;
            Texture texture = textureResources.ListBlockTexture.FirstOrDefault(x => x.name == $"{CurrentTheme}.{randomTexture}");
            GameObject blockInstance = ObjectPoolManager.SpawnObject(blockPrefab, Vector3.zero, Quaternion.identity);

            blockInstance.transform.parent = tetrisBlock.transform;
            blockInstance.transform.localPosition = position;
            blockInstance.transform.localScale = new Vector3(blockScale, blockScale, blockScale);
            blockInstance.GetComponent<Renderer>().material.mainTexture = texture;
            blockInstance.name = randomTexture.ToString();
        }


        // Thiết lập tâm của khối tetris
        SetPivotPoint(tetrisBlock, blockType);
        return tetrisBlock;
    }
    
    // Trả về danh sách vị trí các khối con dựa trên loại khối Tetris
    private List<Vector3> GetBlockPositions(BlockType blockType)
    {
        List<Vector3> positions = new List<Vector3>();
        float sizeX = blockSize / 2;
        switch (blockType)
        {
            case BlockType.o:
                positions.Add(new Vector3(0, 0, 0));
                break;

            case BlockType.oo:
                positions.Add(new Vector3(-sizeX, -sizeX, 0));
                positions.Add(new Vector3(sizeX, -sizeX, 0));
                break;

            case BlockType.i:
                positions.Add(new Vector3(-sizeX*2, 0, 0));
                positions.Add(new Vector3(0, 0, 0));
                positions.Add(new Vector3(sizeX*2, 0, 0));
                break;

            case BlockType.l:
                positions.Add(new Vector3(0, sizeX*2, 0));
                positions.Add(new Vector3(0, 0, 0));
                positions.Add(new Vector3(sizeX*2, 0, 0));
                break;

            case BlockType.j:
                positions.Add(new Vector3(0, sizeX*2, 0));
                positions.Add(new Vector3(0, 0, 0));
                positions.Add(new Vector3(-sizeX*2, 0, 0));
                break;

            case BlockType.I:
                // Khối I (một hàng ngang 4 ô)
                positions.Add(new Vector3(-sizeX*3, -sizeX, 0));
                positions.Add(new Vector3(-sizeX, -sizeX, 0));
                positions.Add(new Vector3(sizeX, -sizeX, 0));
                positions.Add(new Vector3(sizeX*3, -sizeX, 0));
                break;
                
            case BlockType.O:
                // Khối O (hình vuông 2x2)
                positions.Add(new Vector3(-sizeX, sizeX, 0));
                positions.Add(new Vector3(-sizeX, -sizeX, 0));
                positions.Add(new Vector3(sizeX, -sizeX, 0));
                positions.Add(new Vector3(sizeX, sizeX, 0));
                break;
                
            case BlockType.T:
                // Khối T
                positions.Add(new Vector3(0, sizeX*2, 0));
                positions.Add(new Vector3(0, 0, 0));
                positions.Add(new Vector3(-sizeX*2, 0, 0));
                positions.Add(new Vector3(sizeX*2, 0, 0));
                break;
                
            case BlockType.L:
                // Khối L
                positions.Add(new Vector3(0, sizeX*2, 0));
                positions.Add(new Vector3(0, 0, 0));
                positions.Add(new Vector3(0, -sizeX*2, 0));
                positions.Add(new Vector3(sizeX*2, -sizeX*2, 0));
                break;
                
            case BlockType.J:
                // Khối J
                positions.Add(new Vector3(0, sizeX*2, 0));
                positions.Add(new Vector3(0, 0, 0));
                positions.Add(new Vector3(0, -sizeX*2, 0));
                positions.Add(new Vector3(-sizeX*2, -sizeX*2, 0));
                break;
                
            case BlockType.S:
                // Khối S
                positions.Add(new Vector3(sizeX*2, sizeX*2, 0));
                positions.Add(new Vector3(0, sizeX*2, 0));
                positions.Add(new Vector3(0, 0, 0));
                positions.Add(new Vector3(-sizeX*2, 0, 0));
                break;
                
            case BlockType.Z:
                // Khối Z
                positions.Add(new Vector3(-sizeX*2, sizeX*2, 0));
                positions.Add(new Vector3(0, sizeX*2, 0));
                positions.Add(new Vector3(0, 0, 0));
                positions.Add(new Vector3(sizeX*2, 0, 0));
                break;
        }
        
        return positions;
    }
    
    // Thiết lập điểm tâm của khối Tetris
    private void SetPivotPoint(GameObject tetrisBlock, BlockType blockType)
    {
        float XX = FirstBlockPosition.x + blockSize * 4;
        float YY = -FirstBlockPosition.y - GetBlockPositions(blockType)[0].y + MapFrame.transform.position.y*2;

        switch (blockType)
        {
            case BlockType.oo:
            case BlockType.I:
            case BlockType.O:
                tetrisBlock.transform.position = new Vector3(XX - blockSize / 2, YY - blockSize/2, FirstBlockPosition.z);
                break;
            default:
                tetrisBlock.transform.position = new Vector3(XX, YY, FirstBlockPosition.z);
                break;
        }
    }

    public void CreateRandomBlock()
    {
        // Chọn một loại khối ngẫu nhiên
        BlockType randomType = (BlockType)Random.Range(0, 12);
        // randomType = BlockType.I;

        // Tạo khối và đặt ở vị trí bắt đầu
        CreateTetrisBlock(randomType);

        PlayerBlock.GetComponent<Movement>().StartMoveDown();
    }

    public void ChangePlayerBlockToRainbow()
    {
        int PlayerBlockLength = PlayerBlock.transform.childCount;
        if(PlayerBlockLength > 1)
        {
            for(int i = 0; i < 1;)
            {
                Transform child = PlayerBlock.transform.GetChild(0);
                child.name = "Block";
                ObjectPoolManager.ReturnObjectToPool(child.gameObject);
                child.SetParent(PoolBlock.transform);
                PlayerBlockLength--;
                if(PlayerBlockLength == 1) break;
            }
        }
        
        float XX = FirstBlockPosition.x + blockSize * 4;
        float YY = -FirstBlockPosition.y + MapFrame.transform.position.y * 2;

        PlayerBlock.transform.position = new Vector3 (XX, YY, PlayerBlock.transform.position.z);
        Transform lastPlayerChild = PlayerBlock.transform.GetChild(0);
        lastPlayerChild.name = "Rainbow";
        lastPlayerChild.localPosition = Vector3.zero;
        lastPlayerChild.GetComponent<Renderer>().material.mainTexture = 
            textureResources.ListBlockTexture.FirstOrDefault(x => x.name == "Rainbow");
    }
#endregion

#region Create Map
    string MapDirection = "";
    void SetRandomRange(int map,int[][] blockListData)
    {
        float mapa = (float)map % 20f;
        MapDirection = "";
        switch (mapa)
        {
            case 1:
                RandomRange = new int[] { 1, 4 };
                break;
            case 2:
                RandomRange = new int[] { 5, 8 };
                MapDirection = "right";
                break;
            case 3:
                RandomRange = new int[] { 2, 5 };
                break;
            case 4:
                RandomRange = new int[] { 4, 7 };
                MapDirection = "left";
                break;
            case 5:
                RandomRange = new int[] { 1, 5 };
                break;
            case 6:
                RandomRange = new int[] { 5, 8 };
                break;
            case 7:
                RandomRange = new int[] { 3, 6 };
                MapDirection = "left";
                break;
            case 8:
                RandomRange = new int[] { 4, 8 };
                break;
            case 9:
                RandomRange = new int[] { 3, 6 };
                MapDirection = "right";
                break;
            case 10:
                RandomRange = new int[] { 3, 7 };
                break;
            case 11:
                RandomRange = new int[] { 4, 7 };
                break;
            case 12:
                RandomRange = new int[] { 1, 4 };
                MapDirection = "left";
                break;
            case 13:
                RandomRange = new int[] { 2, 4 };
                MapDirection = "left";
                break;
            case 14:
                RandomRange = new int[] { 2, 5 };
                break;
            case 15:
                RandomRange = new int[] { 3, 7 };
                break;
            case 16:
                RandomRange = new int[] { 5, 8 };
                MapDirection = "right";
                break;
            case 17:
                RandomRange = new int[] { 5, 8 };
                MapDirection = "right";
                break;
            case 18:
                RandomRange = new int[] { 4, 8 };
                break;
            case 19:
                RandomRange = new int[] { 1, 4 };
                MapDirection = "right";
                break;
            case 0:
                RandomRange = new int[] { 3, 8 };
                break;
        }
    }

    public bool CheckMapLimit(int currentMap)
    {
        if (currentMap - saveDataJson.TakeMapData().map.Length >= MapList.Length)
        {
            return false;
        }
        return true;
    }

    public void CreateLever(int map)
    {
        bool isRandomMap = false;
        int[][] blockListData = null;
        CurrentTheme = (int)saveDataJson.GetData("CurrentTheme");

        if (map < saveDataJson.TakeMapData().map.Length)
        {
            RandomRange = saveDataJson.TakeMapData().map[map].RandomRange;
            blockListData = saveDataJson.TakeMapData().map[map].BlockList;
        }
        else
        {
            isRandomMap = true;
            SetRandomRange(map, blockListData);
            if(map % 20f == 8 || map % 20f == 16) blockListData = null;
            else 
            {
                SaveDataJson.MapShape[] mapList = saveDataJson.TakeMapShapeList().MapList;
                if (map - saveDataJson.TakeMapData().map.Length < MapList.Length)
                    blockListData = mapList[MapList[map - saveDataJson.TakeMapData().map.Length]].Map;
                else
                    blockListData = mapList[Random.Range(0, mapList.Length)].Map;
            }
        }

        ListPlayerBlock.Clear();
        Vector2 landmarkPocation = GetLandmarkPocation();
        GameObject firstBlock = ObjectPoolManager.SpawnObject(blockPrefab, blockPrefab.transform.position, Quaternion.identity);
        Transform ListBlockTransform = ListBlock.transform;

        if (landmarkPocation.x / landmarkPocation.y > 9 / 16f)
        {
            blockScale = -landmarkPocation.y * 2 / 16 / firstBlock.GetComponent<MeshFilter>().mesh.bounds.size.x;
        }
        else blockScale = (-landmarkPocation.x * 2 - 5) / 9 / firstBlock.GetComponent<MeshFilter>().mesh.bounds.size.x;
        landmarkPocation.x = -blockScale * 8;
        // 5: kich thuoc khung
        // 9: so luong block hang ngang
        firstBlock.transform.localScale = new Vector3(blockScale, blockScale, blockScale);

        float blockFrameScale = -landmarkPocation.x * 2 / GetMeshSize(BlockFrame.transform).x;
        BlockFrame.transform.localScale = BlockFrame.transform.localScale * blockFrameScale;
        BlockFrame.transform.position = new Vector3(0, 0, 90 + 4);

        blockSize = GetMeshSize(firstBlock.transform).x;
        FirstBlockPosition = new Vector3(landmarkPocation.x, landmarkPocation.y + blockSize / 2 + MapFrame.transform.position.y, 90 + blockScale);

        if (blockListData == null)
        {
            firstBlock.name = "Block";
            ObjectPoolManager.ReturnObjectToPool(firstBlock);
            firstBlock.transform.SetParent(PoolBlock.transform);
        }
        else
        {
            int blockListDataHigh = blockListData.Length;
            GameObject newBlock;
            for (int i = 0; i < blockListDataHigh; i++)
            {
                for (int j = 0; j < 9; j++)
                {
                    // int randomTexture = Random.Range(1, 8);
                    int x = blockListDataHigh - i - 1;
                    if (blockListData[x][j] == 0) continue;
                    int randomTexture = blockListData[x][j];

                    if (randomTexture == -1 || isRandomMap) randomTexture = Random.Range(RandomRange[0], RandomRange[1] + 1);

                    if (ListBlockTransform.transform.childCount == 0) newBlock = firstBlock;
                    else newBlock = ObjectPoolManager.SpawnObject(blockPrefab, Vector3.zero, Quaternion.identity);

                    newBlock.transform.localScale = firstBlock.transform.localScale;
                    newBlock.transform.position = FirstBlockPosition + new Vector3(j * blockSize, i * blockSize, 0);
                    newBlock.transform.SetParent(ListBlockTransform);
                    newBlock.GetComponent<Renderer>().material.mainTexture =
                        textureResources.ListBlockTexture.FirstOrDefault(x => x.name == $"{CurrentTheme}.{randomTexture}");
                    newBlock.name = randomTexture.ToString();
                    grid[i, j] = newBlock;
                }
            }
            totalStar = 0;
        }

        Initialize();

        if (map % 20f == 3 || map % 20f == 6|| map % 20f == 20|| map % 20f == 13)
        {
            SetQuestionBlock();
            SetQuestionBlock();
            SetQuestionBlock();
        }
        int time = MoveBlocksInTheSpecifiedDirection("start");
        Invoke("CreateRandomBlock", 0.1f * time);
    }

    void SetQuestionBlock()
    {
        int i = Random.Range(0, 10);
        int j = Random.Range(0, 9);
        if (grid[i, j] == null) { SetQuestionBlock(); return; }

        List<GameObject> nearbyBlocks = new List<GameObject>();
        CheckSameNearbyBlock(nearbyBlocks, grid[i, j], i, j);

        if (nearbyBlocks.Count < 2) { SetQuestionBlock(); return; }

        foreach (GameObject block in nearbyBlocks)
        {
            block.GetComponent<Renderer>().material.mainTexture =
                textureResources.ListBlockTexture.FirstOrDefault(x => x.name == "Question");
        }
    }

    void CheckQuestionBlock(int x, int y)
    {
        GameObject block;
        if (x + 1 < grid.GetLength(0) && grid[x + 1, y] != null)
        {
            block = grid[x + 1, y];
            if (block.GetComponent<Renderer>().material.mainTexture.name == "Question")
            {
                block.GetComponent<Renderer>().material.mainTexture =
                    textureResources.ListBlockTexture.FirstOrDefault(x => x.name == $"{CurrentTheme}.{block.name}");
            }
        }
        if(x - 1 >= 0 && grid[x - 1, y] != null) 
        {
            block = grid[x - 1, y];
            if (block.GetComponent<Renderer>().material.mainTexture.name == "Question")
            {
                block.GetComponent<Renderer>().material.mainTexture =
                    textureResources.ListBlockTexture.FirstOrDefault(x => x.name == $"{CurrentTheme}.{block.name}");
            }
        }
        if(y + 1 < grid.GetLength(1) && grid[x, y + 1] != null) 
        {
            block = grid[x, y + 1];
            if (block.GetComponent<Renderer>().material.mainTexture.name == "Question")
            {
                block.GetComponent<Renderer>().material.mainTexture =
                    textureResources.ListBlockTexture.FirstOrDefault(x => x.name == $"{CurrentTheme}.{block.name}");
            }
        }
        if(y - 1 >= 0 && grid[x, y - 1] != null) 
        {
            block = grid[x, y - 1];
            if (block.GetComponent<Renderer>().material.mainTexture.name == "Question")
            {
                block.GetComponent<Renderer>().material.mainTexture =
                    textureResources.ListBlockTexture.FirstOrDefault(x => x.name == $"{CurrentTheme}.{block.name}");
            }
        }
    }
#endregion

    #region Functions Caculate
    public Vector2 GetCanvasSizeInUnits()
    {
        if (targetCanvas == null)
        {
            Debug.LogError("Canvas not assigned!");
            return Vector2.zero;
        }

        RectTransform canvasRect = targetCanvas.GetComponent<RectTransform>();
        Vector2 size = Vector2.zero;

        switch (targetCanvas.renderMode)
        {
            case RenderMode.ScreenSpaceOverlay:
            case RenderMode.ScreenSpaceCamera:
                // Trong chế độ Screen Space, đơn vị là pixels
                size = canvasRect.rect.size;
                Debug.Log("Canvas size in pixels: " + size);

                // Chuyển đổi từ pixels sang đơn vị thế giới nếu có camera
                if (targetCanvas.renderMode == RenderMode.ScreenSpaceCamera && targetCanvas.worldCamera != null)
                {
                    // Lấy khoảng cách từ canvas đến camera
                    float distance = Mathf.Abs(targetCanvas.planeDistance);

                    // Tính kích thước trong đơn vị thế giới
                    Camera cam = targetCanvas.worldCamera;
                    float height = 2.0f * distance * Mathf.Tan(cam.fieldOfView * 0.5f * Mathf.Deg2Rad);
                    float width = height * cam.aspect;

                    // Tỷ lệ giữa kích thước pixel và kích thước thế giới
                    float pixelToUnitRatio = height / Screen.height;

                    size.x *= pixelToUnitRatio;
                    size.y *= pixelToUnitRatio;

                    Debug.Log("Canvas size in world units: " + size);
                }
                break;

            case RenderMode.WorldSpace:
                // Trong World Space, đơn vị đã là đơn vị thế giới (unit)
                size = new Vector2(
                    canvasRect.rect.width * canvasRect.localScale.x,
                    canvasRect.rect.height * canvasRect.localScale.y
                );
                Debug.Log("Canvas size in world units: " + size);
                break;
        }

        return size;
    }

    Vector3 GetMeshSize(Transform block)
    {
        MeshFilter meshFilter = block.GetComponent<MeshFilter>();
        if (meshFilter != null && meshFilter.mesh != null)
        {
            // Lấy kích thước nguyên bản của mesh
            Vector3 size = meshFilter.mesh.bounds.size;
            // Debug.Log("Kích thước mesh: " + size);

            // Kích thước thực tế với scale
            Vector3 scaledSize = Vector3.Scale(size, block.transform.localScale);
            // Debug.Log("Kích thước thực tế: " + scaledSize);
            return scaledSize;
        }
        return Vector3.zero;
    }

    Vector2 GetLandmarkPocation()
    {
        RectTransform rectBody = MapFrame.GetComponent<RectTransform>();

        float uiWidthInUnits = rectBody.rect.x * targetCanvas.transform.localScale.x;
        float uiHeightInUnits = rectBody.rect.y * targetCanvas.transform.localScale.y;
        // float uiHeightInUnits = rectBody.rect.y * targetCanvas.transform.localScale.y + rectBody.position.y;

        return new Vector2(uiWidthInUnits, uiHeightInUnits);
    }

    public bool IsValidPosition(Transform block)
    {
        foreach (Transform child in block)
        {
            Vector3 childPosition = child.position;
            int x = Mathf.FloorToInt((childPosition.y - FirstBlockPosition.y) / blockSize);
            int y = Mathf.RoundToInt((childPosition.x - FirstBlockPosition.x) / blockSize);
            
            if (x >= 0 && x < grid.GetLength(0) && y >= 0 && y < grid.GetLength(1))
            {
                // if(grid[x - 1, y - 1]) {return false;};
                if(grid[x, y] != null)
                {
                    return false;
                }
                // else grid[x, y] = true;
            }
            else if(x <= 0)
            {
                return false;
            };
        }
        return true;
    }

    public void LockPlayerBlock(string txt = "")
    {
        List<GameObject> listChildBlock = new List<GameObject>();
        ListPlayerBlock.Clear();
        isPlayerBlockMoveDown = false;

        int total = PlayerBlock.transform.childCount;
        for(int i = 0; i < 1;)
        {
            total--;
            if(total == 0) i++;
            Transform child = PlayerBlock.transform.GetChild(0);
            Vector3 childPosition = child.position;
            int x = Mathf.RoundToInt((childPosition.y - FirstBlockPosition.y) / blockSize);
            int y = Mathf.RoundToInt((childPosition.x - FirstBlockPosition.x) / blockSize);
            CheckQuestionBlock(x, y);

            if (grid[x, y] == null && x < 16) grid[x, y] = child.gameObject;
            else
            {
                LoseGame();
                return;
            }

            child.position = new Vector3(FirstBlockPosition.x + y * blockSize, FirstBlockPosition.y + x * blockSize, child.position.z);
            ListPlayerBlock.Add(child.gameObject);
            child.SetParent(ListBlock.transform);
            listChildBlock.Add(child.gameObject);
        }

        CheckListBlock(listChildBlock);
    }

    void CheckListBlock(List<GameObject> listChildBlock)
    {
        if(listChildBlock[0].name == "Rainbow")
        {
            CheckRainbowBlock(listChildBlock[0]);
            return;
        }

        int time = 0;
        foreach(GameObject childBlock in listChildBlock)
        {
            Vector3 childPosition = childBlock.transform.position;
            int x = Mathf.RoundToInt((childPosition.y - FirstBlockPosition.y) / blockSize);
            int y = Mathf.RoundToInt((childPosition.x - FirstBlockPosition.x) / blockSize);
            List<GameObject> nearbyBlocks = new List<GameObject>();
            CheckSameNearbyBlock(nearbyBlocks, childBlock, x, y);
            int largestTime = 0;
            if(nearbyBlocks.Count > 2) largestTime = DeleteListBlock(nearbyBlocks);
            if(largestTime > time) time = largestTime;
        }
        
        if (time == 0) WaitForMove();
        else StartCoroutine(CheckGrid(time * 0.1f + 0.3f));
    }

    int DeleteListBlock (List<GameObject> list)
    {
        int time = 0;
        
        int firstX = Mathf.RoundToInt((list[0].transform.position.y - FirstBlockPosition.y) / blockSize);
        int firstY = Mathf.RoundToInt((list[0].transform.position.x - FirstBlockPosition.x) / blockSize);
        gameManager.CheckScore(list[0].name, list.Count);

        int countItem = 0;
        foreach(GameObject child in list)
        {
            if(DOTween.IsTweening(child)) break;
            int x = Mathf.RoundToInt((child.transform.position.y - FirstBlockPosition.y) / blockSize);
            int y = Mathf.RoundToInt((child.transform.position.x - FirstBlockPosition.x) / blockSize);
            int childTimer = Mathf.Abs(firstX - x) + Mathf.Abs(firstY - y);
            if(childTimer > time) time = childTimer;

            child.transform.DOScale(child.transform.localScale * 1.2f, 0.1f).SetEase(Ease.OutBounce).SetDelay(0.1f * childTimer).OnComplete(() => {
                child.transform.DOScale(Vector3.zero, 0.2f).OnComplete(() => {
                    child.name = "Block";
                    ObjectPoolManager.ReturnObjectToPool(child);
                    child.transform.SetParent(PoolBlock.transform);
                });
            });
            grid[x, y] = null;

            countItem++;
            if(countItem > 3)
            {
                PlayStarAnimation(child, 0.1f * childTimer + 0.1f);
            }

        }
        return time;
    }

    bool isPlayerBlockMoveDown = false;

    IEnumerator CheckGrid(float time, string txt = null)
    {
        int timer = 0;

        yield return new WaitForSeconds(time);
        // Debug.Log(grid[1, 4]);
        for(int i = 0; i < 16; i++)
        {
            for(int j = 0; j < 9; j++)
            {
                GameObject block = grid[i, j];
                if(block != null)
                {
                    if(i - 1 >= 0 && grid[i - 1, j] == null)
                    {
                        List<GameObject> nearbyBlocks = new List<GameObject>();
                        CheckNearbyBlock(nearbyBlocks, block.transform, i, j);
                        GameObject checkBlock = nearbyBlocks.Find(block => Mathf.RoundToInt((block.transform.position.y - FirstBlockPosition.y) / blockSize) == 0);

                        if(checkBlock == null) 
                        {
                            int endTime = MoveBlockToBottom(nearbyBlocks);
                            if(endTime > timer && endTime != 16) timer = endTime;
                        }
                    }
                }
            }
        }

        if (isPlayerBlockMoveDown) Invoke("CheckPlayerBlockAgain", 0.1f * (float)timer);
        else if (txt == null) Invoke("WaitForMove", 0.1f * (float)timer);
        else if (txt != null) Invoke("CheckMoveBlocksInTheSpecifiedDirection", 0.1f * (float)timer);
    }

    void CheckPlayerBlockAgain()
    {
        List<GameObject> listChildBlock = ListPlayerBlock;
        isPlayerBlockMoveDown = false;
        CheckListBlock(listChildBlock);
    }

    void CheckMoveBlocksInTheSpecifiedDirection()
    {
        int timer = MoveBlocksInTheSpecifiedDirection("tool");
        Invoke("DisableTouchInSupportTools", 0.1f * timer);
        // supportTools.DisableTouch();
    }

    void DisableTouchInSupportTools()
    {
        supportTools.DisableTouch();
    }

    int MoveBlockToBottom(List<GameObject> nearbyBlocks)
    {
        int shortest = 16;
        foreach(GameObject child in nearbyBlocks)
        {
            if(DOTween.IsTweening(child.transform)) break;
            int x = Mathf.RoundToInt((child.transform.position.y - FirstBlockPosition.y) / blockSize);
            int y = Mathf.RoundToInt((child.transform.position.x - FirstBlockPosition.x) / blockSize);
            int count = 0;
            for(int i = x - 1; i >= 0; i--)
            {
                if(grid[i,y] == null) count++;
                else if(nearbyBlocks.Contains(grid[i,y]))
                {
                    count = 16;
                    break;
                }
                else break;
            }

            if(shortest > count) shortest = count;
        }

        if(shortest < 16)
        {
            foreach(GameObject child in nearbyBlocks)
            {
                int x = Mathf.RoundToInt((child.transform.position.y - FirstBlockPosition.y) / blockSize);
                int y = Mathf.RoundToInt((child.transform.position.x - FirstBlockPosition.x) / blockSize);
                grid[x, y] = null;
                if(!isPlayerBlockMoveDown && ListPlayerBlock.Contains(child)) isPlayerBlockMoveDown = true;

                child.transform.DOMove(new Vector3(child.transform.position.x, FirstBlockPosition.y + (x - shortest) * blockSize, child.transform.position.z), 0.1f * shortest);
            }

            foreach(GameObject child in nearbyBlocks)
            {
                int x = Mathf.RoundToInt((child.transform.position.y - FirstBlockPosition.y) / blockSize);
                int y = Mathf.RoundToInt((child.transform.position.x - FirstBlockPosition.x) / blockSize);
                // grid[x, y] = null;
                grid[x - shortest, y] = child;
            }
        }

        return shortest;
    }

    void WaitForMove()
    {
        int time = MoveBlocksInTheSpecifiedDirection();
        Invoke("CheckWinGame", 0.1f * time);
    }

    void CheckWinGame()
    {
        gameManager.CheckWinGame();
    }

    public void CheckNearbyBlock(List<GameObject> nearbyBlocks, Transform block, int x, int y)
    {
        if (nearbyBlocks.Contains(block.gameObject)) return;
        nearbyBlocks.Add(block.gameObject);

        if (x + 1 < grid.GetLength(0) && grid[x + 1, y] != null)
        {
            CheckNearbyBlock(nearbyBlocks, grid[x + 1, y].transform, x + 1, y);
        }
        if (x - 1 >= 0 && grid[x - 1, y] != null)
        {
            CheckNearbyBlock(nearbyBlocks, grid[x - 1, y].transform, x - 1, y);
        }
        if (y + 1 < grid.GetLength(1) && grid[x, y + 1] != null)
        {
            CheckNearbyBlock(nearbyBlocks, grid[x, y + 1].transform, x, y + 1);
        }
        if (y - 1 >= 0 && grid[x, y - 1] != null)
        {
            CheckNearbyBlock(nearbyBlocks, grid[x, y - 1].transform, x, y - 1);
        }
    }

    public void CheckSameNearbyBlock(List<GameObject> nearbyBlocks,  GameObject block, int x, int y)
    {
        if(nearbyBlocks.Contains(block)) return;
        nearbyBlocks.Add(block);

        if(x + 1 < grid.GetLength(0) && grid[x + 1, y] != null && block.name == grid[x + 1, y].name) 
        {
            CheckSameNearbyBlock(nearbyBlocks, grid[x + 1, y], x + 1, y);
        }
        if(x - 1 >= 0 && grid[x - 1, y] != null && block.name == grid[x - 1, y].name) 
        {
            CheckSameNearbyBlock(nearbyBlocks, grid[x - 1, y], x - 1, y);
        }
        if(y + 1 < grid.GetLength(1) && grid[x, y + 1] != null && block.name == grid[x, y + 1].name) 
        {
            CheckSameNearbyBlock(nearbyBlocks, grid[x, y + 1], x, y + 1);
        }
        if(y - 1 >= 0 && grid[x, y - 1] != null && block.name == grid[x, y - 1].name) 
        {
            CheckSameNearbyBlock(nearbyBlocks, grid[x, y - 1], x, y - 1);
        }
    }

    public bool CheckBlockTouch(float nextPositionX, Transform block, float nextBlockPosition)
    {
        foreach (Transform child in block)
        {
            Vector3 childPosition = child.position;
            int x = Mathf.FloorToInt((childPosition.y - FirstBlockPosition.y) / blockSize);
            x = x == -1 ? 0 : x;
            int xNext = Mathf.FloorToInt((childPosition.y + nextBlockPosition - FirstBlockPosition.y) / blockSize);
            int y = Mathf.RoundToInt((childPosition.x - FirstBlockPosition.x) / blockSize);
            if(x > xNext)
            {
                if(nextPositionX > 0)
                {
                    if(grid[x, y + 1] != null) return false;
                }
                else
                {
                    if(grid[x, y - 1] != null) return false;
                }
            }
            else
            {
                if(nextPositionX > 0)
                {
                    if(grid[x, y + 1] != null) return false;
                    if(x + 1 < grid.GetLength(0) && grid[x + 1, y + 1] != null) return false;
                }
                else
                {
                    if(grid[x, y - 1] != null) return false;
                    if(x + 1 < grid.GetLength(0) && grid[x + 1, y - 1] != null) return false;
                }
            }
        }
        return true;
    }

    public bool CheckBlockTouchWhenRotate(List<Vector3> listNewPosition, Transform block)
    {
        bool touchLeft = false;
        bool touchRight = false;
        bool touchTop = false;
        bool touchBottom = false;

        for(int i = 0; i < listNewPosition.Count; i++)
        {
            Vector3 childlocalPosition = listNewPosition[i];
            Vector3 childPosition = childlocalPosition + block.position;
            int x = Mathf.FloorToInt((childPosition.y - FirstBlockPosition.y) / blockSize);
            int y = Mathf.RoundToInt((childPosition.x - FirstBlockPosition.x) / blockSize);

            if(x >= 0 && x < grid.GetLength(0) && y >= 0 && y < grid.GetLength(1))
            {
                if(grid[x, y] != null)
                {
                    if(Mathf.Round(childlocalPosition.x) > 0) touchRight = true;
                    else if(Mathf.Round(childlocalPosition.x) < 0) touchLeft = true;
                    if(Mathf.Round(childlocalPosition.y) > 0) touchTop = true;
                    else if(Mathf.Round(childlocalPosition.y) < 0) touchBottom = true;
                    // return false;
                }
            }
            else 
            {
                if(x < 0) touchBottom = true;
                if(x >= grid.GetLength(0)) touchTop = true;
                if(y < 0) touchLeft = true;
                if(y >= grid.GetLength(1)) touchRight = true;
                // return false;
            }
        }

        if((touchLeft && touchRight) || (touchBottom && touchTop)) return false;
        string status = "";
        if(touchLeft)
        {
            if(touchTop) status = "topLeft";
            else if (touchBottom) status = "bottomLeft";
            else status = "left";
        }
        else if(touchRight)
        {
            if(touchTop) status = "topRight";
            else if (touchBottom) status = "bottomRight";
            else status = "right";
        }
        else if (touchTop) status = "top";
        else if (touchBottom) status = "bottom";
        else return true;

        return IsValidToRotate(listNewPosition, block, status);
    }

    bool IsValidToRotate (List<Vector3> listNewPosition, Transform block, string txt)
    {
        float xx = 0;
        float yy = 0;

        switch (txt)
        {
            case "left":
                xx = blockSize;
                break;
            case "right":
                xx = -blockSize;
                break;
            case "top":
                yy = -blockSize;
                break;
            case "bottom":
                yy = blockSize;
                break;
            case "topLeft":
                xx = blockSize;
                yy = -blockSize;
                break;
            case "topRight":
                xx = -blockSize;
                yy = -blockSize;
                break;
            case "bottomLeft":
                xx = blockSize;
                yy = blockSize;
                break;
            case "bottomRight":
                xx = -blockSize;
                yy = blockSize;
                break;
        }

        if(block.name == "I")
        {
            float child0X = block.GetChild(0).localPosition.x;
            if((txt == "left" && child0X > 0) || (txt == "right" && child0X < 0))
            {
                xx *= 2;
                yy *= 2;
            }
        }

        if(xx != 0 && yy != 0)
        {
            if(!CheckTouchAfterMoveBlock(listNewPosition, block, new Vector3(xx, 0, 0)))
            {
                if(!CheckTouchAfterMoveBlock(listNewPosition, block, new Vector3(0, yy, 0)))
                {
                    if(!CheckTouchAfterMoveBlock(listNewPosition, block, new Vector3(xx, yy, 0)))
                    {
                        return false;
                    }
                    else block.position += new Vector3 (xx, yy, 0);
                }
                else block.position += new Vector3 (0, yy, 0);
            }
            else block.position += new Vector3 (xx, 0, 0);
        }
        else
        {
            if(CheckTouchAfterMoveBlock(listNewPosition, block, new Vector3(xx, yy, 0)))
                block.position += new Vector3 (xx, yy, 0);
            else return false;
        }

        return true;
    }

    bool CheckTouchAfterMoveBlock (List<Vector3> listNewPosition, Transform block, Vector3 pos)
    {
        for(int i = 0; i < listNewPosition.Count; i++)
        {
            Vector3 childPosition = listNewPosition[i] + block.position + pos;
            int x = Mathf.FloorToInt((childPosition.y - FirstBlockPosition.y) / blockSize);
            int y = Mathf.RoundToInt((childPosition.x - FirstBlockPosition.x) / blockSize);

            if(x >= 0 && x < grid.GetLength(0) && y >= 0 && y < grid.GetLength(1))
            {
                if(grid[x, y] != null) return false;
            }
            else return false;
        }
        return true;
    }

    public float CheckNextPosition(float distance)
    {
        // int xLength = grid.GetLength(0);
        // int yLength = grid.GetLength(1);
        foreach (Transform child in PlayerBlock.transform)
        {
            Vector3 childPosition = child.position;
            int x = Mathf.FloorToInt((childPosition.y - FirstBlockPosition.y + distance) / blockSize);
            int y = Mathf.RoundToInt((childPosition.x - FirstBlockPosition.x) / blockSize);
            
            if (x >= 0 && x < 16 && y >= 0 && y < 9)
            {
                if(grid[x, y] != null)
                {
                    x++;
                    return FirstBlockPosition.y  +  (blockSize * x) - childPosition.y;
                }
            }
            else if(x <= 0)
            {
                return FirstBlockPosition.y - childPosition.y;
            };
        }
        return distance;
    }

    int MoveBlocksInTheSpecifiedDirection(string txt = "")
    {
        int time = 0;
        if(MapDirection == "")
        {
            if (txt == "") CreateRandomBlock();
            return time;
        }

        if (MapDirection == "right")
        {
            for (int i = 0; i < 16; i++)
            {
                int countEmptyBlock = 0;
                for (int j = 8; j >= 0; j--)
                {
                    GameObject block = grid[i, j];
                    if (block == null) { countEmptyBlock++; continue; }
                    if (countEmptyBlock > 0)
                    {
                        time = time < countEmptyBlock ? countEmptyBlock : time;
                        block.transform.DOMove(new Vector3(FirstBlockPosition.x + (j + countEmptyBlock) * blockSize, block.transform.position.y, block.transform.position.z), 0.1f * countEmptyBlock);
                        grid[i, j + countEmptyBlock] = block;
                        grid[i, j] = null;
                    }
                }
            }
        }
        else if (MapDirection == "left")
        {
            for (int i = 0; i < 16; i++)
            {
                int countEmptyBlock = 0;
                for (int j = 0; j < 9; j++)
                {
                    GameObject block = grid[i, j];
                    if (block == null) { countEmptyBlock++; continue; }
                    if (countEmptyBlock > 0)
                    {
                        time = time < countEmptyBlock ? countEmptyBlock : time;
                        block.transform.DOMove(new Vector3(FirstBlockPosition.x + (j - countEmptyBlock) * blockSize, block.transform.position.y, block.transform.position.z), 0.1f * countEmptyBlock);
                        grid[i, j - countEmptyBlock] = block;
                        grid[i, j] = null;
                    }
                }
            }
        }

        if (txt == "") Invoke("CheckListPlayerBlock", 0.1f * time);

        return time;
    }

    int ListPlayerBlockLength = 10;
    void CheckListPlayerBlock()
    {
        int listPlayerBlockLength = 0;
        if (ListPlayerBlockLength == 10)
        {
            foreach (GameObject child in ListPlayerBlock)
            {
                if (child.transform.parent.name == "ListBlock")
                {
                    listPlayerBlockLength++;
                }
            }
        }

        if (listPlayerBlockLength > 0 && listPlayerBlockLength < ListPlayerBlockLength)
        {
            ListPlayerBlockLength = listPlayerBlockLength;
            CheckPlayerBlockAgain();
            return;
        }

        ListPlayerBlockLength = 10;
        CreateRandomBlock();
    }
#endregion

#region Tool
    List<GameObject> ListBlockInfluence = new List<GameObject>();
    // GameObject firstBlock;
    public void CheckListBlockToDestroy(string ToolType, Vector2 CurrentTouch)
    {
        int x = Mathf.RoundToInt((CurrentTouch.y - FirstBlockPosition.y) / blockSize);
        int y = Mathf.RoundToInt((CurrentTouch.x - FirstBlockPosition.x) / blockSize);
        if (x < 0 || x >= 16 || y < 0 || y >= 9)
        {
            RedoListBlockInfluence();
            ListBlockInfluence.Clear();
            return;
        }

        if (ListBlockInfluence.Count > 0)
        {
            if (grid[x, y] == ListBlockInfluence[0]) return;
            RedoListBlockInfluence();
        }
        
        ListBlockInfluence.Clear();

        if (grid[x, y] != null) ListBlockInfluence.Add(grid[x, y]);

        GameObject child;
        switch (ToolType)
        {
            case "Boom":
                for (int i = x - 1; i <= x + 1; i++)
                {
                    for (int j = y - 1; j <= y + 1; j++)
                    {
                        if (i < 0 || i >= 16 || j < 0 || j >= 9) continue;
                        child = grid[i, j];
                        if (child == null) continue;
                        ListBlockInfluence.Add(child);
                    }
                }
                break;
            case "TNT":
                for (int i = x; i < 16; i++)
                {
                    child = grid[i, y];
                    if (child == null) continue;
                    ListBlockInfluence.Add(child);
                }

                for (int i = x - 1; i >= 0; i--)
                {
                    child = grid[i, y];
                    if (child == null) continue;
                    ListBlockInfluence.Add(child);
                }
                break;
            case "Hammer":
                for (int j = y; j < 9; j++)
                {
                    child = grid[x, j];
                    if (child == null) continue;
                    ListBlockInfluence.Add(child);
                }

                for (int j = y - 1; j >= 0; j--)
                {
                    child = grid[x, j];
                    if (child == null) continue;
                    ListBlockInfluence.Add(child);
                }
                break;
        }

        // StartCoroutine(PlayAnimListBlockInfluence(ListBlockInfluence));
        ShowListBlockInfluence();
    }

    public void RedoListBlockInfluence()
    {
        foreach(GameObject child in ListBlockInfluence)
        {
            child.GetComponent<Renderer>().material.color = Color.white;
        }
    }
    
    void ShowListBlockInfluence()
    {
        foreach (GameObject child in ListBlockInfluence)
        {
            child.GetComponent<Renderer>().material.color = new Color(0.5f, 0.5f, 0.5f, 1f);
        }
    }

    public bool ActiveBoom()
    {
        if (ListBlockInfluence.Count == 0) return false;
        RedoListBlockInfluence();
        int timer = DeleteListBlock(ListBlockInfluence);
        ListBlockInfluence.Clear();

        StartCoroutine(CheckGrid(0.3f + 0.1f * timer, "tool"));
        return true;
    }

    public bool DeleteHorizontalRow()
    {
        // xoá hàng ngang
        if (ListBlockInfluence.Count == 0) return false;

        RedoListBlockInfluence();
        int timer = DeleteListBlock(ListBlockInfluence);
        ListBlockInfluence.Clear();

        StartCoroutine(CheckGrid(0.3f + 0.1f * timer, "tool"));
        return true;
    }

    public bool DeleteVerticalRow()
    {
        // xoá hàng dọc
        if (ListBlockInfluence.Count == 0) return false;

        RedoListBlockInfluence();
        int timer = DeleteListBlock(ListBlockInfluence);
        ListBlockInfluence.Clear();

        StartCoroutine(CheckGrid(0.3f + 0.1f * timer, "tool"));
        return true;
    }

    void CheckRainbowBlock(GameObject block)
    {
        Vector3 blockPosition = block.transform.position;
        int x = Mathf.RoundToInt((blockPosition.y - FirstBlockPosition.y) / blockSize);
        int y = Mathf.RoundToInt((blockPosition.x - FirstBlockPosition.x) / blockSize);
        List<GameObject> ListnearbyBlock1 = new List<GameObject>();
        List<GameObject> ListnearbyBlock2 = new List<GameObject>();
        List<GameObject> ListnearbyBlock3 = new List<GameObject>();
        List<GameObject> ListnearbyBlock4 = new List<GameObject>();
        List<GameObject> ListnearbyBlock = new List<GameObject>();
        int timer = 0;
        int count = 0;

        if(x + 1 < grid.GetLength(0) && grid[x + 1, y] != null) 
        {
            // ListnearbyBlock1.Add(block);
            CheckSameNearbyBlock(ListnearbyBlock1, grid[x + 1, y], x + 1, y);
            if(ListnearbyBlock1.Count > 1) count = DeleteListBlock(ListnearbyBlock1);
            else ListnearbyBlock.Add(grid[x + 1, y]);
            timer = count > timer ? count : timer;
        }
        if(x - 1 >= 0 && grid[x - 1, y] != null) 
        {
            // ListnearbyBlock2.Add(block);
            CheckSameNearbyBlock(ListnearbyBlock2, grid[x - 1, y], x - 1, y);
            if(ListnearbyBlock2.Count > 1) count = DeleteListBlock(ListnearbyBlock2);
            else ListnearbyBlock.Add(grid[x - 1, y]);
            timer = count > timer ? count : timer;
        }
        if(y + 1 < grid.GetLength(1) && grid[x, y + 1] != null) 
        {
            // ListnearbyBlock3.Add(block);
            CheckSameNearbyBlock(ListnearbyBlock3, grid[x, y + 1], x, y + 1);
            if(ListnearbyBlock3.Count > 1) count = DeleteListBlock(ListnearbyBlock3);
            else ListnearbyBlock.Add(grid[x, y + 1]);
            timer = count > timer ? count : timer;
        }
        if(y - 1 >= 0 && grid[x, y - 1] != null) 
        {
            // ListnearbyBlock4.Add(block);
            CheckSameNearbyBlock(ListnearbyBlock4, grid[x, y - 1], x, y - 1);
            if(ListnearbyBlock4.Count > 1) count = DeleteListBlock(ListnearbyBlock4);
            else ListnearbyBlock.Add(grid[x, y - 1]);
            timer = count > timer ? count : timer;
        }

        if(ListnearbyBlock.Count > 1)
        {
            count = CountUsingLINQ(ListnearbyBlock);
            timer = count > timer ? count : timer;
        }

        supportTools.DisableTouch();

        if (timer > 0)
        {
            timer++;
            block.name = "Block";
            block.transform.DOScale(block.transform.localScale * 1.2f, 0.1f).SetEase(Ease.OutBounce).OnComplete(() =>
            {
                block.transform.DOScale(Vector3.zero, 0.2f).OnComplete(() =>
                {
                    ObjectPoolManager.ReturnObjectToPool(block);
                    block.transform.SetParent(PoolBlock.transform);
                });
            });
            grid[x, y] = null;
            StartCoroutine(CheckGrid(timer * 0.1f + 0.3f));
        }
        else
        {
            if (x > 0)
            {
                SetRaibowBlock(block, grid[x - 1, y]);
            }
            else
            {
                if (y < 8 && grid[x, y + 1] != null) SetRaibowBlock(block, grid[x, y + 1]);
                else if (y > 0 && grid[x, y - 1] != null) SetRaibowBlock(block, grid[x, y - 1]);
                else if (x < 15 && grid[x + 1, y] != null) SetRaibowBlock(block, grid[x, y - 1]);
                else
                {
                    int randomTexture = Random.Range(1, 8);
                    Texture texture = textureResources.ListBlockTexture.FirstOrDefault(x => x.name == $"{CurrentTheme}.{randomTexture}");
                    block.name = texture.name;
                    block.GetComponent<Renderer>().material.mainTexture = texture;
                }
            }

            int time = MoveBlocksInTheSpecifiedDirection();
        }
    }

    int CountUsingLINQ(List<GameObject> list)
    {
        var groupedObjects = list.GroupBy(obj => obj.name);
        int timer = 0;
        foreach (var group in groupedObjects)
        {
            if(group.Count() > 1)
            {
                int count = 0;
                if(list.Count == group.Count()) count = DeleteListBlock(list);
                else
                {
                    List<GameObject> listBlock = list.FindAll(item => item.name == group.Key);
                    count = DeleteListBlock(listBlock);
                }
                timer = count > timer ? count : timer;
            }
        }
        return timer;
    }

    void SetRaibowBlock (GameObject block, GameObject blockToCopy)
    {
        block.name = blockToCopy.name;
        block.GetComponent<Renderer>().material.mainTexture = 
            blockToCopy.GetComponent<Renderer>().material.mainTexture;
    }
#endregion

#region Particle
    void PlayStarAnimation (GameObject block, float val)
    {
        Transform star = ObjectPoolManager.SpawnObject(StarPrefab, block.transform.position , Quaternion.identity).transform;
        Image starImage = star.GetComponent<Image>();
        star.SetParent(ListStar.transform);
        star.position = new Vector3(star.position.x, star.position.y, 90);
        star.localScale = Vector3.zero;
        Color newColor = starImage.color;
        newColor.a = 1;
        starImage.color = newColor;
        totalStar += 1;
        star.DOScale(1, 0.2f).SetEase(Ease.OutBounce).SetDelay(val);
        // star.DORotate(new Vector3(0,0, 360 *5), 1.2f);
        starImage.DOFade(0, 0.5f).SetDelay(0.4f + val);
    }
#endregion
    void ResetListBlock()
    {
        for(int i = 0; i < 16; i++)
        {
            for(int j = 0; j < 9; j++)
            {
                GameObject block = grid[i,j];
                if(block == null) continue;
                block.name = "Block";
                ObjectPoolManager.ReturnObjectToPool(block);
                block.transform.SetParent(PoolBlock.transform);
                grid[i, j] = null;
            }
        }

        int playerBlockChildCount = PlayerBlock.transform.childCount;
        for(int i = 0; i < 1;)
        {
            playerBlockChildCount--;
            if(playerBlockChildCount < 0) break;
            Transform block = PlayerBlock.transform.GetChild(0);
            block.name = "Block";
            ObjectPoolManager.ReturnObjectToPool(block.gameObject);
            block.transform.SetParent(PoolBlock.transform);
        }
    }

    public void GameOver()
    {
        PlayerBlock.GetComponent<Movement>().StopAllAction();
        Invoke("ResetListBlock", 0.1f);
    }

    void LoseGame ()
    {
        gameManager.LoseGame();
    }
}